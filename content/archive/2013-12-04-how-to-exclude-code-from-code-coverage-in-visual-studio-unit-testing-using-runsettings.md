---
id: 154795
title: How to exclude code from Code Coverage in Visual Studio unit testing using runsettings
date: 2013-12-04T21:49:02+01:00
author: terje
layout: post
guid: http://terje.wpengine.com/?p=154795
permalink: /how-to-exclude-code-from-code-coverage-in-visual-studio-unit-testing-using-runsettings/
dsq_thread_id:
  - "4134744315"
categories:
  - Code Coverage
  - Unit Testing
  - Visual Studio
---
<p>Download:  <a href="http://visualstudiogallery.msdn.microsoft.com/601bd207-5889-4935-b101-3ebe1f25aafa" target="_blank">VS2012 Runsettingstemplate</a>   <a href="http://visualstudiogallery.msdn.microsoft.com/704ebd18-7d60-4341-9224-532f73229c74" target="_blank">VS2013 Runsettingstemplate</a></p>  <p>The VS2012/13 unit test feature can generate code coverage results.  It can do so for (nearly) any type of adapter you choose to use, MSTest, CPPTest (managed/native), <a href="http://xunit.codeplex.com/" target="_blank">XUnit</a> and <a href="http://nunit.org" target="_blank">NUnit</a> (but not Chutzpah (note 1)). </p>  <p>Assume you have a project with a set of unit tests included.  For this demonstration I have used multiple different test frameworks just to show that this applies to any of these frameworks. </p>  <p>You choose to analyze for code coverage:</p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_2.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb.png" width="354" height="205" /></a> </p>  <p> </p>  <p>The code under test is this:</p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_4.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_1.png" width="352" height="274" /></a> </p>  <p>All the tests we have tests the Add method, none tests the Subtract method, so the expected code coverage should be 50%.</p>  <p>The result we get is this:</p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_6.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_2.png" width="676" height="250" /></a> </p>  <p>The total code coverage is calculated to 88%.  We also see all the tests, which – not surprisingly – is at 100%.  </p>  <p> </p>  <p>Some people find this to be just fine, and want the code coverage to include the tests.  I , for one, are not so keen on this.  I want to see the code coverage of the real production code, and would have expected a result of 50% in this case.  </p>  <p>One can argue in different ways here, but let us assume that you do agree with me – and you want to get this result more correct :-)</p>  <p>We then need to exclude the tests from the code coverage results, and there are two ways to do this. </p>  <p>1) Add an ExcludeFromCodeCoverage attribute to the test classes</p>  <p>2) Add and enable a runsettings file to the solution.  </p>  <p> </p>  <p>Option 1) will be tedious to use when the number of tests goes up, so we will go for Option 2).</p>  <p>After googling “runsettings” you will find <a href="http://msdn.microsoft.com/en-us/library/vstudio/jj159530.aspx" target="_blank">this article</a>, which tells you to copy settings information from that post into an emtpy runsettings file.  That is hard work!  And, if you use those settings, and you use  a 3rd party test adapter you will find more stuff in your test coverage results than you really bargained for.  (In one case I found the testadapters there!) We need to sweeten up this file. </p>  <p>And, we don’t want to do this manually each time.</p>  <p><strong>Solution:  Install the Runsettings solution Item template from here:  </strong><a href="Runsettings solution Item template from here:  http://visualstudiogallery.msdn.microsoft.com/601bd207-5889-4935-b101-3ebe1f25aafa" target="_blank">VS2012 Runsettingstemplate</a>   <a href="http://visualstudiogallery.msdn.microsoft.com/704ebd18-7d60-4341-9224-532f73229c74" target="_blank">VS2013 Runsettingstemplate</a></p>  <p>Now, right click your <strong>Solution</strong>, choose Add Item:</p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_8.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_3.png" width="388" height="92" /></a> </p>  <p>Select the runsettings:</p>  <p>Your solution will get this added:</p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/SNAGHTML216dc13b.png"><img title="SNAGHTML216dc13b" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="SNAGHTML216dc13b" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-SNAGHTML216dc13b_thumb.png" width="363" height="240" /></a></p>  <p>Since we have added the default stuff and also the excludes for the unit testing in this, all you now need to do is to enable the use of this from the Test Menu:</p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_10.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_4.png" width="376" height="133" /></a> </p>  <p>You select the file using the “Select Test Settings File” and then you enable it by ensuring it has been checked.</p>  <p> </p>  <p>Now when we run the Test Coverage we get this very nice result:</p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_12.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_5.png" width="609" height="158" /></a> </p>  <p>Compared to the results above, it is less clutter, as the irrelevant test code is not included in the results.  The resulting numbers are also more correct, imho. </p>  <h3> </h3>  <h3>Removing test code based on file exclusions</h3>  <p>Most often your test code is placed in projects and assemblies suffixed with “Test”.  You can then use this as an exclusion criteria.  In that case you must open the runsettings file and add that criteria to the list.</p>  <p>Note, you don’t need to do this if your test files only contains attributed test classes, then the default runsettings file from the extension above will handle them.</p>  <p>Find  the section in the file named ModulePaths and add the relevant pattern there under the Exclude section.  Note that the patterns are Regular Expressions, and that special characters like ‘.’ and ‘*’may have special meanings. Test the exclusion properly.  See “Regular expressions” in this <a href="http://msdn.microsoft.com/en-us/library/jj159530%28v=vs.110%29.aspx" target="_blank">MSDN post</a>. </p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_14.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_6.png" width="477" height="77" /></a> </p>  <p> </p>  <p> </p>  <h3>Handling special test code</h3>  <p>If you have code in your test project that is not covered by attributes, that code can be excluded by adding the <strong>ExcludeFromCodeCoverageAttribute</strong> to that part of the code, either class or method.  This can f.e. be stub classes or mocking classes, or common test code that does not have any of the other exclusion attributes. </p>  <p> </p>  <h3>TFS Build</h3>  <p>Note that The TFS Build templates also have a property for setting the runsettingsfile. </p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_18.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_8.png" width="610" height="123" /></a> </p>  <p>This is the default setup, which means there is no coverage data.  If you select CodeCoverageEnabled( or …ForAspNetApps) then the standard codecoverage will be performed.  If you select a runsettings file, which must have been checked in to the repository, the Type goes to UserSpecified, and the specifications in the selected runsettings file takes effect. </p>  <p><a href="https://gwb.blob.core.windows.net/terje/WindowsLiveWriter/HowtoexcludecodefromCodeCoverageinVisual_13AEF/image_20.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://hermit.no/wp-content/uploads/2015/08/GWB-WindowsLiveWriter-HowtoexcludecodefromCodeCoverageinVisual_13AEF-image_thumb_9.png" width="618" height="47" /></a> </p>  <p>Note that this don’t apply if you use the MSTest runner, but in TFS 2013, the VSTest runner is the default. </p>  <p> </p>  <p>Note 1:   VS Test runner can’t find code coverage for javascript code, there is no dll’s to analyze, so it doesn’t work for Chutzpah, which handles QUnit andJasmine. </p>